<!-- This is the reference file for the converted components -->
<!-- I want to break to component level, in Next/TypeScript application, SEO friendly, modern and elegant styling, logo is /rs-rm.png  -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      RepetitionSpotter - Professional tool for detecting and analyzing text
      repetitions
    </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .ql-editor {
        min-height: 400px;
        font-size: 16px;
        line-height: 1.6;
      }

      /* VSCode-style highlighting */
      .highlight-selection {
        background-color: rgba(173, 214, 255, 0.3);
        border: 1px solid #007acc;
        border-radius: 2px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .highlight-matches {
        background-color: rgba(255, 193, 7, 0.4);
        border: 1px solid #ffc107;
        border-radius: 2px;
        animation: pulse-highlight 1s ease-in-out;
      }

      .highlight-current {
        background-color: rgba(40, 167, 69, 0.4);
        border: 2px solid #28a745;
        border-radius: 2px;
        box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
      }

      @keyframes pulse-highlight {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      /* Level-based highlighting colors */
      .level-paragraph {
        background-color: rgba(220, 53, 69, 0.2);
        border-color: #dc3545;
      }
      .level-sentence {
        background-color: rgba(255, 193, 7, 0.2);
        border-color: #ffc107;
      }
      .level-phrase {
        background-color: rgba(40, 167, 69, 0.2);
        border-color: #28a745;
      }
      .level-word {
        background-color: rgba(0, 123, 255, 0.2);
        border-color: #007bff;
      }

      .logo-placeholder {
        width: 120px;
        height: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
      }

      .detection-level-btn {
        transition: all 0.2s ease;
      }

      .detection-level-btn.active {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .repetition-item {
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
      }

      .repetition-item:hover {
        transform: translateX(4px);
        border-left-color: #3b82f6;
      }

      .stats-card {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center space-x-4">
            <div class="logo-placeholder">RS-RM</div>
            <div>
              <h1 class="text-2xl font-bold text-gray-900">
                RepetitionSpotter
              </h1>
              <p class="text-sm text-gray-500">
                Professional tool for detecting and analyzing text repetitions
              </p>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <span class="text-sm text-gray-600">Next.js + TypeScript</span>
            <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
          </div>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Main Editor Area -->
        <div class="lg:col-span-3">
          <!-- Detection Level Controls -->
          <div
            class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-6"
          >
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
              Detection Levels & Advanced Options
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <button
                class="detection-level-btn active bg-red-100 hover:bg-red-200 text-red-800 px-4 py-3 rounded-lg font-medium transition-colors"
                data-level="paragraph"
                onclick="setDetectionLevel('paragraph')"
              >
                üìÑ Paragraphs
              </button>
              <button
                class="detection-level-btn bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-4 py-3 rounded-lg font-medium transition-colors"
                data-level="sentence"
                onclick="setDetectionLevel('sentence')"
              >
                üìù Sentences
              </button>
              <button
                class="detection-level-btn bg-green-100 hover:bg-green-200 text-green-800 px-4 py-3 rounded-lg font-medium transition-colors"
                data-level="phrase"
                onclick="setDetectionLevel('phrase')"
              >
                üî§ Phrases
              </button>
              <button
                class="detection-level-btn bg-blue-100 hover:bg-blue-200 text-blue-800 px-4 py-3 rounded-lg font-medium transition-colors"
                data-level="word"
                onclick="setDetectionLevel('word')"
              >
                üî§ Words
              </button>
            </div>

            <!-- Advanced Detection Options -->
            <div class="border-t border-gray-200 pt-4">
              <h4 class="text-sm font-semibold text-gray-700 mb-3">
                Advanced Detection
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <label class="flex items-center space-x-2">
                  <input
                    type="checkbox"
                    id="semanticSimilarity"
                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span class="text-sm text-gray-700">Semantic Similarity</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input
                    type="checkbox"
                    id="ignoreCase"
                    checked
                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span class="text-sm text-gray-700">Ignore Case</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input
                    type="checkbox"
                    id="ignorePunctuation"
                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span class="text-sm text-gray-700">Ignore Punctuation</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Editor -->
          <div
            class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden"
          >
            <div class="p-6 border-b border-gray-200">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-900">
                  WYSIWYG Editor
                </h2>
                <div class="flex items-center space-x-4">
                  <button
                    id="clearHighlights"
                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                  >
                    Clear Highlights
                  </button>
                  <button
                    id="clearText"
                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                  >
                    Clear Text
                  </button>
                  <button
                    id="analyzeText"
                    class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors"
                  >
                    üîç Analyze
                  </button>
                </div>
              </div>

              <!-- Controls -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Minimum Length:
                    <span id="minLengthValue" class="font-bold text-blue-600"
                      >3</span
                    >
                    words
                  </label>
                  <input
                    type="range"
                    id="minLengthSlider"
                    min="1"
                    max="20"
                    value="3"
                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Similarity Threshold:
                    <span id="similarityValue" class="font-bold text-blue-600"
                      >80</span
                    >%
                  </label>
                  <input
                    type="range"
                    id="similaritySlider"
                    min="50"
                    max="100"
                    value="80"
                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                  />
                </div>
              </div>
            </div>

            <div class="p-6">
              <div id="editor"></div>
            </div>
          </div>

          <!-- Statistics Cards -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-8">
            <div
              class="stats-card rounded-xl shadow-lg border border-gray-200 p-6"
            >
              <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100">
                  <svg
                    class="w-6 h-6 text-blue-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                    ></path>
                  </svg>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-gray-600">Total Words</p>
                  <p id="wordCount" class="text-2xl font-bold text-gray-900">
                    0
                  </p>
                </div>
              </div>
            </div>

            <div
              class="stats-card rounded-xl shadow-lg border border-gray-200 p-6"
            >
              <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100">
                  <svg
                    class="w-6 h-6 text-yellow-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"
                    ></path>
                  </svg>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-gray-600">Repetitions</p>
                  <p
                    id="repetitionCount"
                    class="text-2xl font-bold text-gray-900"
                  >
                    0
                  </p>
                </div>
              </div>
            </div>

            <div
              class="stats-card rounded-xl shadow-lg border border-gray-200 p-6"
            >
              <div class="flex items-center">
                <div class="p-3 rounded-full bg-red-100">
                  <svg
                    class="w-6 h-6 text-red-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                  </svg>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-gray-600">Instances</p>
                  <p
                    id="instanceCount"
                    class="text-2xl font-bold text-gray-900"
                  >
                    0
                  </p>
                </div>
              </div>
            </div>

            <div
              class="stats-card rounded-xl shadow-lg border border-gray-200 p-6"
            >
              <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100">
                  <svg
                    class="w-6 h-6 text-green-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2h-2a2 2 0 00-2 2z"
                    ></path>
                  </svg>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-gray-600">Efficiency</p>
                  <p
                    id="efficiencyScore"
                    class="text-2xl font-bold text-gray-900"
                  >
                    100%
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1">
          <div
            class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden"
          >
            <div class="p-6 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900">
                Detected Repetitions
              </h3>
              <p class="text-sm text-gray-500 mt-1">
                Click to highlight matches
              </p>
              <div
                id="selectionInfo"
                class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden"
              >
                <div class="flex items-center">
                  <svg
                    class="w-4 h-4 text-blue-600 mr-2"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                  </svg>
                  <span class="text-sm font-medium text-blue-800"
                    >Selection Analysis</span
                  >
                </div>
                <p id="selectionText" class="text-xs text-blue-600 mt-1"></p>
              </div>
            </div>

            <div class="p-4">
              <div class="mb-4">
                <input
                  type="text"
                  id="searchRepetitions"
                  placeholder="Search repetitions..."
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                />
              </div>

              <div
                id="repetitionsList"
                class="space-y-2 max-h-96 overflow-y-auto"
              >
                <div class="text-center text-gray-500 py-8">
                  <svg
                    class="w-12 h-12 mx-auto mb-4 text-gray-300"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                    ></path>
                  </svg>
                  <p class="text-sm">No repetitions detected</p>
                  <p class="text-xs text-gray-400 mt-1">
                    Add text and click "Analyze"
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Chart Section -->
          <div
            class="bg-white rounded-xl shadow-lg border border-gray-200 mt-6 overflow-hidden"
          >
            <div class="p-6 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900">
                Analysis Chart
              </h3>
            </div>
            <div class="p-6">
              <canvas id="repetitionChart" width="300" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let quill;
      let currentLevel = 'paragraph';
      let repetitions = [];
      let chart;

      // Initialize Quill Editor
      const toolbarOptions = [
        ['bold', 'italic', 'underline', 'strike'],
        ['blockquote', 'code-block'],
        [{ header: 1 }, { header: 2 }],
        [{ list: 'ordered' }, { list: 'bullet' }],
        [{ script: 'sub' }, { script: 'super' }],
        [{ indent: '-1' }, { indent: '+1' }],
        [{ direction: 'rtl' }],
        [{ size: ['small', false, 'large', 'huge'] }],
        [{ header: [1, 2, 3, 4, 5, 6, false] }],
        [{ color: [] }, { background: [] }],
        [{ font: [] }],
        [{ align: [] }],
        ['clean'],
      ];

      quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
          toolbar: toolbarOptions,
        },
        placeholder:
          'Paste your text here for VSCode-style repetition analysis...',
      });

      // Add sample text with intentional repetitions for testing
      quill.setContents([
        {
          insert:
            'Welcome to RepetitionSpotter, the advanced text analysis tool. This tool helps you identify repeated content in your writing. The tool uses sophisticated algorithms to detect repetitions at multiple levels.\n\n',
        },
        {
          insert:
            'The analysis tool works by examining your text for repeated sequences. The tool can detect paragraphs, sentences, phrases, and individual words that appear multiple times. This makes the tool particularly useful for academic writing.\n\n',
        },
        {
          insert:
            'To get started with the tool, simply paste your text into the editor above. The tool will automatically analyze your content and highlight any repetitions it finds. You can adjust the detection level to focus on different types of repetitions.\n\n',
        },
        {
          insert:
            'Welcome to RepetitionSpotter, the advanced text analysis tool. This tool helps you identify repeated content in your writing. The tool uses sophisticated algorithms to detect repetitions at multiple levels.\n\n',
        },
        {
          insert:
            'The analysis tool works by examining your text for repeated sequences. The tool can detect paragraphs, sentences, phrases, and individual words that appear multiple times. This makes the tool particularly useful for academic writing.\n\n',
        },
        {
          insert:
            'To get started with the tool, simply paste your text into the editor above. The tool will automatically analyze your content and highlight any repetitions it finds. You can adjust the detection level to focus on different types of repetitions.\n\n',
        },
        {
          insert:
            'Welcome to RepetitionSpotter, the advanced text analysis tool. This tool helps you identify repeated content in your writing. The tool uses sophisticated algorithms to detect repetitions at multiple levels.\n\n',
        },
        {
          insert:
            'The analysis tool works by examining your text for repeated sequences. The tool can detect paragraphs, sentences, phrases, and individual words that appear multiple times. This makes the tool particularly useful for academic writing.\n\n',
        },
        {
          insert:
            'To get started with the tool, simply paste your text into the editor above. The tool will automatically analyze your content and highlight any repetitions it finds. You can adjust the detection level to focus on different types of repetitions.',
        },
      ]);

      // Initialize Chart
      const ctx = document.getElementById('repetitionChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Unique Content', 'Repetitions'],
          datasets: [
            {
              data: [100, 0],
              backgroundColor: ['#10b981', '#f59e0b'],
              borderWidth: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
            },
          },
        },
      });

      // Event Listeners
      document
        .getElementById('minLengthSlider')
        .addEventListener('input', function () {
          document.getElementById('minLengthValue').textContent = this.value;
        });

      document
        .getElementById('similaritySlider')
        .addEventListener('input', function () {
          document.getElementById('similarityValue').textContent = this.value;
        });

      document
        .getElementById('analyzeText')
        .addEventListener('click', analyzeText);
      document.getElementById('clearText').addEventListener('click', clearText);
      document
        .getElementById('clearHighlights')
        .addEventListener('click', clearHighlights);
      document
        .getElementById('searchRepetitions')
        .addEventListener('input', filterRepetitions);

      // Advanced options event listeners
      document
        .getElementById('semanticSimilarity')
        .addEventListener('change', function () {
          if (quill.getText().trim().length > 0) {
            analyzeText();
          }
        });

      document
        .getElementById('ignoreCase')
        .addEventListener('change', function () {
          if (quill.getText().trim().length > 0) {
            analyzeText();
          }
        });

      document
        .getElementById('ignorePunctuation')
        .addEventListener('change', function () {
          if (quill.getText().trim().length > 0) {
            analyzeText();
          }
        });

      // Selection handling for VSCode-style highlighting
      quill.on('selection-change', function (range, oldRange, source) {
        if (range && range.length > 0) {
          const selectedText = quill.getText(range.index, range.length).trim();
          if (selectedText.length > 0) {
            highlightSimilarText(selectedText, range);
            findAndDisplaySelectionRepetitions(selectedText, range);
            showSelectionInfo(selectedText, range);
          }
        } else {
          clearSelectionHighlights();
          hideSelectionInfo();
          displayRepetitions(repetitions); // Show original analysis
        }
      });

      function setDetectionLevel(level) {
        currentLevel = level;

        // Update button states
        document.querySelectorAll('.detection-level-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document
          .querySelector(`[data-level="${level}"]`)
          .classList.add('active');

        // Re-analyze if there's content
        if (quill.getText().trim().length > 0) {
          analyzeText();
        }
      }

      function analyzeText() {
        const text = quill.getText();
        if (!text.trim()) return;

        clearHighlights();

        switch (currentLevel) {
          case 'paragraph':
            repetitions = findParagraphRepetitions(text);
            break;
          case 'sentence':
            repetitions = findSentenceRepetitions(text);
            break;
          case 'phrase':
            repetitions = findPhraseRepetitions(text);
            break;
          case 'word':
            repetitions = findWordRepetitions(text);
            break;
        }

        updateStatistics(text, repetitions);
        displayRepetitions(repetitions);
        updateChart(text, repetitions);
      }

      function findParagraphRepetitions(text) {
        const paragraphs = text.split('\n\n').filter(p => p.trim().length > 0);
        const repetitions = [];
        const seen = new Map();

        // Single paragraph repetitions
        paragraphs.forEach((paragraph, index) => {
          const normalized = paragraph.trim().toLowerCase();
          if (normalized.length > 50) {
            if (seen.has(normalized)) {
              seen.get(normalized).push({
                index: index,
                originalText: paragraph.trim(),
              });
            } else {
              seen.set(normalized, [
                {
                  index: index,
                  originalText: paragraph.trim(),
                },
              ]);
            }
          }
        });

        // Multi-paragraph combinations (2-5 consecutive paragraphs)
        for (let len = 2; len <= Math.min(5, paragraphs.length); len++) {
          for (let i = 0; i <= paragraphs.length - len; i++) {
            const combination = paragraphs
              .slice(i, i + len)
              .map(p => p.trim())
              .join('\n\n');
            const normalizedCombination = combination.toLowerCase();

            if (normalizedCombination.length > 100) {
              const key = `multi_${len}_${normalizedCombination}`;
              if (seen.has(key)) {
                seen.get(key).push({
                  index: i,
                  originalText: combination,
                });
              } else {
                seen.set(key, [
                  {
                    index: i,
                    originalText: combination,
                  },
                ]);
              }
            }
          }
        }

        seen.forEach((matches, content) => {
          if (matches.length > 1) {
            const isMulti = content.startsWith('multi_');
            const actualContent = isMulti
              ? content.substring(content.indexOf('_', 6) + 1)
              : content;
            const paragraphCount = isMulti
              ? parseInt(content.split('_')[1])
              : 1;
            const originalText = matches[0].originalText;

            repetitions.push({
              text:
                originalText.substring(0, 150) +
                (originalText.length > 150 ? '...' : ''),
              fullText: originalText,
              count: matches.length,
              level: 'paragraph',
              paragraphCount: paragraphCount,
              indices: matches.map(m => m.index),
              matches: matches,
            });
          }
        });

        return repetitions.sort((a, b) => b.count - a.count);
      }

      function findSentenceRepetitions(text) {
        const sentences = text.match(/[^\.!?]+[\.!?]+/g) || [];
        const repetitions = [];
        const seen = new Map();

        sentences.forEach((sentence, index) => {
          const normalized = sentence.trim().toLowerCase();
          if (normalized.length > 20) {
            // Only consider substantial sentences
            if (seen.has(normalized)) {
              seen.get(normalized).push(index);
            } else {
              seen.set(normalized, [index]);
            }
          }
        });

        seen.forEach((indices, sentence) => {
          if (indices.length > 1) {
            repetitions.push({
              text: sentence.trim(),
              fullText: sentence.trim(),
              count: indices.length,
              level: 'sentence',
              indices: indices,
            });
          }
        });

        return repetitions.sort((a, b) => b.count - a.count);
      }

      function findPhraseRepetitions(text) {
        const minLength = parseInt(
          document.getElementById('minLengthSlider').value
        );
        const words = text.toLowerCase().match(/\b\w+\b/g) || [];
        const repetitions = [];
        const seen = new Map();

        for (let len = minLength; len <= Math.min(10, words.length); len++) {
          for (let i = 0; i <= words.length - len; i++) {
            const phrase = words.slice(i, i + len).join(' ');
            if (seen.has(phrase)) {
              seen.get(phrase).push(i);
            } else {
              seen.set(phrase, [i]);
            }
          }
        }

        seen.forEach((indices, phrase) => {
          if (indices.length > 1) {
            repetitions.push({
              text: phrase,
              fullText: phrase,
              count: indices.length,
              level: 'phrase',
              indices: indices,
            });
          }
        });

        return repetitions.sort((a, b) => b.count - a.count);
      }

      function findWordRepetitions(text) {
        const minLength = parseInt(
          document.getElementById('minLengthSlider').value
        );
        const words = text.toLowerCase().match(/\b\w+\b/g) || [];
        const repetitions = [];
        const seen = new Map();

        // Find sequences of words based on minimum length setting
        for (let len = minLength; len <= Math.min(20, words.length); len++) {
          for (let i = 0; i <= words.length - len; i++) {
            const sequence = words.slice(i, i + len).join(' ');

            // Only consider sequences with substantial content
            if (sequence.length > 10) {
              if (seen.has(sequence)) {
                seen.get(sequence).push(i);
              } else {
                seen.set(sequence, [i]);
              }
            }
          }
        }

        // Also include single words if minimum length is 1
        if (minLength === 1) {
          const wordCount = {};
          words.forEach((word, index) => {
            if (word.length > 3) {
              if (wordCount[word]) {
                wordCount[word].push(index);
              } else {
                wordCount[word] = [index];
              }
            }
          });

          Object.entries(wordCount).forEach(([word, indices]) => {
            if (indices.length > 1) {
              seen.set(word, indices);
            }
          });
        }

        seen.forEach((indices, sequence) => {
          if (indices.length > 1) {
            repetitions.push({
              text:
                sequence.length > 100
                  ? sequence.substring(0, 100) + '...'
                  : sequence,
              fullText: sequence,
              count: indices.length,
              level: 'word',
              indices: indices,
              wordCount: sequence.split(' ').length,
            });
          }
        });

        return repetitions.sort((a, b) => b.count - a.count);
      }

      function highlightSimilarText(selectedText, range) {
        clearSelectionHighlights();

        const fullText = quill.getText();
        const regex = new RegExp(escapeRegExp(selectedText), 'gi');
        let match;

        // First highlight the selection itself
        quill.formatText(range.index, range.length, 'background', '#add8e6');

        // Then highlight all matches
        while ((match = regex.exec(fullText)) !== null) {
          if (match.index !== range.index) {
            quill.formatText(
              match.index,
              match[0].length,
              'background',
              '#ffeb3b'
            );
          }
        }
      }

      function findAndDisplaySelectionRepetitions(selectedText, range) {
        const fullText = quill.getText();
        const ignoreCase = document.getElementById('ignoreCase').checked;
        const ignorePunctuation =
          document.getElementById('ignorePunctuation').checked;
        const semanticSimilarity =
          document.getElementById('semanticSimilarity').checked;

        let processedText = selectedText;
        if (ignorePunctuation) {
          processedText = processedText.replace(/[^\w\s]/g, '');
        }

        const flags = ignoreCase ? 'gi' : 'g';
        const regex = new RegExp(escapeRegExp(processedText), flags);
        const matches = [];
        let match;

        let searchText = fullText;
        if (ignorePunctuation) {
          searchText = fullText.replace(/[^\w\s]/g, '');
        }

        while ((match = regex.exec(searchText)) !== null) {
          const originalIndex = findOriginalIndex(
            fullText,
            match.index,
            ignorePunctuation
          );
          if (originalIndex !== range.index) {
            // Don't include the selection itself
            matches.push({
              index: originalIndex,
              text: match[0],
              context: getContext(fullText, originalIndex, match[0].length),
              similarity: calculateSimilarity(selectedText, match[0]),
            });
          }
        }

        // Add semantic similarity matches if enabled
        if (semanticSimilarity && matches.length < 10) {
          const semanticMatches = findSemanticMatches(
            selectedText,
            fullText,
            range
          );
          matches.push(...semanticMatches);
        }

        if (matches.length > 0) {
          const selectionRepetition = {
            text:
              selectedText.length > 100
                ? selectedText.substring(0, 100) + '...'
                : selectedText,
            fullText: selectedText,
            count: matches.length + 1, // +1 for the selection itself
            level: determineSelectionLevel(selectedText),
            matches: matches,
            isSelection: true,
            range: range,
          };

          displaySelectionRepetitions([selectionRepetition]);
        } else {
          displaySelectionRepetitions([]);
        }
      }

      function findOriginalIndex(fullText, processedIndex, ignorePunctuation) {
        if (!ignorePunctuation) return processedIndex;

        let originalIndex = 0;
        let processedCount = 0;

        for (
          let i = 0;
          i < fullText.length && processedCount < processedIndex;
          i++
        ) {
          if (!/[^\w\s]/.test(fullText[i])) {
            processedCount++;
          }
          originalIndex = i + 1;
        }

        return originalIndex;
      }

      function findSemanticMatches(selectedText, fullText, range) {
        const matches = [];
        const words = selectedText.toLowerCase().split(/\s+/);
        const sentences = fullText.match(/[^\.!?]+[\.!?]+/g) || [];

        sentences.forEach((sentence, index) => {
          const sentenceWords = sentence.toLowerCase().split(/\s+/);
          const commonWords = words.filter(
            word =>
              word.length > 3 &&
              sentenceWords.some(sw => sw.includes(word) || word.includes(sw))
          );

          if (commonWords.length >= Math.min(3, words.length * 0.6)) {
            const sentenceStart = fullText.indexOf(sentence);
            if (
              sentenceStart !== -1 &&
              (sentenceStart < range.index ||
                sentenceStart >= range.index + range.length)
            ) {
              matches.push({
                index: sentenceStart,
                text: sentence.trim(),
                context: getContext(fullText, sentenceStart, sentence.length),
                similarity: (commonWords.length / words.length) * 100,
                isSemantic: true,
              });
            }
          }
        });

        return matches.slice(0, 5); // Limit semantic matches
      }

      function calculateSimilarity(text1, text2) {
        const words1 = text1.toLowerCase().split(/\s+/);
        const words2 = text2.toLowerCase().split(/\s+/);
        const commonWords = words1.filter(word => words2.includes(word));
        return Math.round(
          (commonWords.length / Math.max(words1.length, words2.length)) * 100
        );
      }

      function showSelectionInfo(selectedText, range) {
        const info = document.getElementById('selectionInfo');
        const textElement = document.getElementById('selectionText');

        const wordCount = selectedText.split(/\s+/).length;
        const charCount = selectedText.length;
        const level = determineSelectionLevel(selectedText);

        textElement.textContent = `Selected: ${wordCount} words, ${charCount} characters (${level} level)`;
        info.classList.remove('hidden');
      }

      function hideSelectionInfo() {
        document.getElementById('selectionInfo').classList.add('hidden');
      }

      function determineSelectionLevel(text) {
        const sentences = text.match(/[^\.!?]+[\.!?]+/g) || [];
        const paragraphs = text.split('\n\n').filter(p => p.trim().length > 0);
        const words = text.match(/\b\w+\b/g) || [];

        if (paragraphs.length > 1) return 'paragraph';
        if (sentences.length >= 1) return 'sentence';
        if (words.length > 5) return 'phrase';
        return 'word';
      }

      function getContext(fullText, index, length) {
        const start = Math.max(0, index - 50);
        const end = Math.min(fullText.length, index + length + 50);
        const context = fullText.substring(start, end);
        return (
          (start > 0 ? '...' : '') +
          context +
          (end < fullText.length ? '...' : '')
        );
      }

      function displaySelectionRepetitions(selectionReps) {
        const container = document.getElementById('repetitionsList');

        if (selectionReps.length === 0) {
          container.innerHTML = `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-sm text-blue-800 font-medium">Selection Analysis</p>
                        </div>
                        <p class="text-xs text-blue-600 mt-1">No repetitions found for selected text</p>
                    </div>
                `;
          return;
        }

        const rep = selectionReps[0];
        const exactMatches = rep.matches.filter(m => !m.isSemantic);
        const semanticMatches = rep.matches.filter(m => m.isSemantic);

        container.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-sm text-green-800 font-medium">Selection Analysis</p>
                        </div>
                        <span class="text-xs font-medium text-green-600 bg-green-100 px-2 py-1 rounded">${rep.count} total</span>
                    </div>
                    <p class="text-sm text-green-700 mb-2">"${rep.text}"</p>
                    <div class="flex items-center space-x-4 text-xs text-green-600">
                        <span class="capitalize">${rep.level} level</span>
                        ${exactMatches.length > 0 ? `<span>${exactMatches.length} exact</span>` : ''}
                        ${semanticMatches.length > 0 ? `<span>${semanticMatches.length} similar</span>` : ''}
                    </div>
                </div>
                
                <div class="space-y-2">
                    ${
                      exactMatches.length > 0
                        ? `
                        <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                            <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                            Exact Matches (${exactMatches.length})
                        </h4>
                        ${exactMatches
                          .map(
                            (match, index) => `
                            <div class="p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors"
                                 onclick="scrollToMatch(${match.index}, ${match.text.length})">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-xs font-medium text-gray-500">Match ${index + 1}</span>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded">${match.similarity || 100}%</span>
                                        <span class="text-xs text-gray-400">Pos ${match.index}</span>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-600 italic">${match.context}</p>
                            </div>
                        `
                          )
                          .join('')}
                    `
                        : ''
                    }
                    
                    ${
                      semanticMatches.length > 0
                        ? `
                        <h4 class="text-sm font-medium text-gray-700 mb-2 mt-4 flex items-center">
                            <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                            Similar Content (${semanticMatches.length})
                        </h4>
                        ${semanticMatches
                          .map(
                            (match, index) => `
                            <div class="p-3 border border-blue-200 bg-blue-50 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors"
                                 onclick="scrollToMatch(${match.index}, ${match.text.length})">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-xs font-medium text-blue-600">Similar ${index + 1}</span>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-blue-600 bg-blue-200 px-2 py-1 rounded">${Math.round(match.similarity)}%</span>
                                        <span class="text-xs text-blue-400">Pos ${match.index}</span>
                                    </div>
                                </div>
                                <p class="text-xs text-blue-600 italic">${match.context}</p>
                            </div>
                        `
                          )
                          .join('')}
                    `
                        : ''
                    }
                </div>
            `;
      }

      function clearSelectionHighlights() {
        const length = quill.getLength();
        quill.formatText(0, length, 'background', false);
        quill.formatText(0, length, 'border', false);
      }

      function highlightRepetition(text, level) {
        clearHighlights();

        const fullText = quill.getText();
        let matchCount = 0;
        let firstMatchIndex = -1;

        if (level === 'paragraph') {
          // For paragraphs, find exact paragraph boundaries
          const paragraphs = fullText.split('\n\n');
          let currentIndex = 0;

          paragraphs.forEach((paragraph, index) => {
            const normalizedParagraph = paragraph.trim().toLowerCase();
            const normalizedText = text.trim().toLowerCase();

            if (normalizedParagraph === normalizedText) {
              // Highlight with distinct borders for each match
              const startIndex = currentIndex;
              const endIndex = currentIndex + paragraph.length;

              // Add border styling to make boundaries clear
              quill.formatText(
                startIndex,
                paragraph.length,
                'background',
                getColorForLevel(level)
              );

              // Add visual separation with border
              if (matchCount === 0) {
                quill.formatText(
                  startIndex,
                  paragraph.length,
                  'border',
                  '2px solid #dc3545'
                );
              } else {
                quill.formatText(
                  startIndex,
                  paragraph.length,
                  'border',
                  '2px dashed #dc3545'
                );
              }

              if (firstMatchIndex === -1) {
                firstMatchIndex = startIndex;
              }
              matchCount++;
            }

            currentIndex += paragraph.length + 2; // +2 for \n\n
          });
        } else {
          // For other levels, use regex matching with enhanced boundaries
          const regex = new RegExp(escapeRegExp(text), 'gi');
          let match;

          while ((match = regex.exec(fullText)) !== null) {
            const startIndex = match.index;
            const length = match[0].length;

            // Apply background color
            quill.formatText(
              startIndex,
              length,
              'background',
              getColorForLevel(level)
            );

            // Add distinct borders for each match
            if (matchCount === 0) {
              quill.formatText(
                startIndex,
                length,
                'border',
                `2px solid ${getBorderColorForLevel(level)}`
              );
            } else {
              quill.formatText(
                startIndex,
                length,
                'border',
                `2px dashed ${getBorderColorForLevel(level)}`
              );
            }

            if (firstMatchIndex === -1) {
              firstMatchIndex = startIndex;
            }
            matchCount++;
          }
        }

        // Scroll to first match and select it
        if (firstMatchIndex !== -1) {
          quill.setSelection(firstMatchIndex, Math.min(text.length, 100));
          quill.focus();
        }
      }

      function getColorForLevel(level) {
        const colors = {
          paragraph: '#ffcdd2',
          sentence: '#fff3e0',
          phrase: '#e8f5e8',
          word: '#e3f2fd',
        };
        return colors[level] || '#f5f5f5';
      }

      function getBorderColorForLevel(level) {
        const colors = {
          paragraph: '#dc3545',
          sentence: '#ffc107',
          phrase: '#28a745',
          word: '#007bff',
        };
        return colors[level] || '#6c757d';
      }

      function clearHighlights() {
        const length = quill.getLength();
        quill.formatText(0, length, 'background', false);
        quill.formatText(0, length, 'border', false);
      }

      function clearText() {
        quill.setText('');
        repetitions = [];
        updateStatistics('', []);
        displayRepetitions([]);
        updateChart('', []);
      }

      function updateStatistics(text, repetitions) {
        const words = text.match(/\b\w+\b/g) || [];
        const totalInstances = repetitions.reduce(
          (sum, rep) => sum + rep.count,
          0
        );
        const efficiency = Math.max(
          0,
          100 - (totalInstances / words.length) * 100
        );

        document.getElementById('wordCount').textContent = words.length;
        document.getElementById('repetitionCount').textContent =
          repetitions.length;
        document.getElementById('instanceCount').textContent = totalInstances;
        document.getElementById('efficiencyScore').textContent =
          Math.round(efficiency) + '%';
      }

      function scrollToMatch(index, length) {
        quill.setSelection(index, length);
        quill.focus();
      }

      function displayRepetitions(repetitions) {
        const container = document.getElementById('repetitionsList');

        if (repetitions.length === 0) {
          container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-sm">No repetitions found!</p>
                        <p class="text-xs text-gray-400 mt-1">Your text looks good</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = repetitions
          .map(
            (rep, index) => `
                <div class="repetition-item p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors" 
                     onclick="highlightRepetition('${rep.fullText.replace(/'/g, "\\'")}', '${rep.level}')">
                    <div class="flex items-center justify-between mb-2">
                        <span class="inline-block w-4 h-4 rounded level-${rep.level}" style="background-color: ${getColorForLevel(rep.level)}"></span>
                        <span class="text-xs font-medium text-gray-500">${rep.count} times</span>
                    </div>
                    <p class="text-sm font-medium text-gray-900 truncate">"${rep.text}"</p>
                    <p class="text-xs text-gray-500 mt-1 capitalize">
                        ${rep.level} level${rep.paragraphCount > 1 ? ` (${rep.paragraphCount} paragraphs)` : ''}${rep.wordCount > 1 ? ` (${rep.wordCount} words)` : ''}
                    </p>
                </div>
            `
          )
          .join('');
      }

      function filterRepetitions() {
        const searchTerm = document
          .getElementById('searchRepetitions')
          .value.toLowerCase();
        const filteredRepetitions = repetitions.filter(rep =>
          rep.text.toLowerCase().includes(searchTerm)
        );
        displayRepetitions(filteredRepetitions);
      }

      function updateChart(text, repetitions) {
        const words = text.match(/\b\w+\b/g) || [];
        const totalWords = words.length;
        const repetitionWords = repetitions.reduce((sum, rep) => {
          return sum + rep.text.split(' ').length * rep.count;
        }, 0);

        const uniqueWords = Math.max(0, totalWords - repetitionWords);

        chart.data.datasets[0].data = [uniqueWords, repetitionWords];
        chart.update();
      }

      function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      // Auto-analyze on load
      setTimeout(() => {
        analyzeText();
      }, 1000);
    </script>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement('script');
            d.innerHTML =
              "window.__CF$cv$params={r:'98299e5d95b5aac6',t:'MTc1ODQ1ODI5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName('head')[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement('iframe');
          a.height = 1;
          a.width = 1;
          a.style.position = 'absolute';
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = 'none';
          a.style.visibility = 'hidden';
          document.body.appendChild(a);
          if ('loading' !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener('DOMContentLoaded', c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              'loading' !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
